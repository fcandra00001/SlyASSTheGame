<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jo Ken Po ‚Äî Sly Ass</title>

  <!-- playful rounded font -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">

  <style>
    :root{--glass-bg: rgba(255,255,255,0.86);--text:#0b1220}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Fredoka One', system-ui, -apple-system,'Segoe UI',Roboto,Arial;background:#000;color:var(--text);-webkit-font-smoothing:antialiased}
    .bg-video{position:fixed;inset:0;z-index:0;overflow:hidden;pointer-events:none}
    .bg-video video{position:absolute;bottom:0;left:50%;transform:translateX(-50%);min-width:100%;min-height:100%;height:auto;width:auto;object-fit:cover;object-position:center bottom;filter:brightness(0.48) contrast(1.05) saturate(1.03);}
    @media (max-width:800px){.bg-video video{ object-position:center 85%; }}@media (max-width:480px){.bg-video video{ object-position:center 92%; }}

    .app{position:relative;z-index:2;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:18px;transition:transform 220ms ease}
    .app.shake{animation:shake 520ms cubic-bezier(.25,.75,.2,1)}
    @keyframes shake{0%{transform:translateY(0)}20%{transform:translateY(-6px) rotate(-0.6deg)}40%{transform:translateY(6px) rotate(0.5deg)}60%{transform:translateY(-4px) rotate(-0.4deg)}80%{transform:translateY(4px) rotate(0.3deg)}100%{transform:translateY(0) rotate(0)}}

    header{width:100%;max-width:1200px;display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{display:flex;flex-direction:column;gap:4px;color:var(--glass-bg);text-shadow:0 8px 28px rgba(0,0,0,0.6)}
    h1{margin:0;font-size:28px;letter-spacing:1px}.subtitle{font-size:12px;opacity:.95}

    .controls{display:flex;gap:10px;align-items:center}
    .btn-ghost{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid rgba(255,255,255,0.12);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03));color:var(--glass-bg);cursor:pointer;font-weight:700}.btn-ghost .dog{font-size:18px}

    .arena-wrap{width:100%;max-width:1200px;display:flex;gap:18px}
    .arena{flex:1;min-height:640px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));backdrop-filter: blur(10px);box-shadow:0 22px 70px rgba(2,6,23,0.65);border:1px solid rgba(255,255,255,0.04);position:relative;overflow:hidden;padding:14px;display:flex;flex-direction:column;align-items:center}
    .arena-inner{position:relative;flex:1;width:100%;border-radius:12px;background:rgba(255,255,255,0.012);overflow:hidden;border:1px solid rgba(255,255,255,0.02);display:block;margin-top:8px}

    .piece-btns{display:flex;gap:10px;justify-content:center;margin-top:6px}
    .piece-btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);padding:12px 18px;border-radius:12px;cursor:pointer;font-size:18px;color:var(--glass-bg);backdrop-filter: blur(4px);}
    .piece-btn.active{box-shadow:0 12px 36px rgba(0,0,0,0.28);transform:translateY(-4px)}

    .hud{width:320px;min-width:240px;display:flex;flex-direction:column;gap:12px}
    .fancy-hud{position:relative;padding:14px;border-radius:14px;background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.08);box-shadow:0 18px 40px rgba(2,6,23,0.18)}
    .fancy-hud::before{content:'';position:absolute;inset:-6px;background:linear-gradient(90deg,#ff6b6b,#ffd166,#8ecae6,#a0e7a0,#c77dff,#ffd6a5);background-size:300% 300%;filter:blur(14px);opacity:0.55;z-index:-2;border-radius:16px;animation:rainbow 9s linear infinite}
    @keyframes rainbow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .counts{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .agent{position:absolute;user-select:none;touch-action:none;font-size:22px;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:10px;transition:transform .12s ease, box-shadow .12s ease}
    .agent.convert{animation:convertFlash 420ms ease-out}
    @keyframes convertFlash{0%{box-shadow:0 0 0px rgba(255,255,255,0)}30%{box-shadow:0 8px 28px rgba(255,255,255,0.9)}100%{box-shadow:0 0 0px rgba(255,255,255,0)}}
    #playerChoiceDisplay{background:linear-gradient(90deg, rgba(0,0,0,0.65), rgba(0,0,0,0.5));color:white;padding:8px 10px;border-radius:10px}

    .victory-title{font-size:18px;font-weight:900;padding:6px 12px;border-radius:10px;display:inline-block;color:#ffd54a;background:linear-gradient(180deg, rgba(255,213,74,0.95), rgba(255,230,120,0.65));box-shadow:0 10px 30px rgba(255,200,60,0.12);text-shadow:0 2px 0 rgba(0,0,0,0.15);position:relative;overflow:visible}
    .loser-title{font-size:18px;font-weight:900;padding:6px 12px;border-radius:10px;display:inline-block;color:#ffd54a;position:relative;overflow:visible;text-shadow:0 2px 0 rgba(0,0,0,0.15)}
    .confetti{position:absolute;inset:0;pointer-events:none;z-index:6}
    .confetti .piece{position:absolute;border-radius:2px;opacity:0.95;animation:fall 1800ms linear forwards}
    @keyframes fall{from{transform:translateY(-20vh) rotate(0)} to{transform:translateY(120vh) rotate(720deg);opacity:0}}

    /* rocket spawn visuals */
    .rocket{position:absolute;left:50%;bottom:6px;translate:-50% 0;font-size:20px;z-index:8;pointer-events:none;opacity:0}
    .spawn-burst{position:absolute;width:10px;height:10px;border-radius:50%;pointer-events:none;z-index:9;opacity:0}

    footer{margin-top:16px;color:rgba(255,255,255,0.9);font-size:12px}
    @media(max-width:1000px){.arena-wrap{flex-direction:column}.hud{width:100%}.arena{min-height:520px}}
    @media(max-width:560px){h1{font-size:18px}.agent{width:28px;height:28px;font-size:16px}}
  </style>
</head>
<body>

  <div class="bg-video">
    <video id="bgVideo" autoplay muted loop playsinline>
      <source src="assets/video/01.mp4" type="video/mp4">
    </video>
  </div>

  <div class="app" id="appContainer">
    <header>
      <div class="title">
        <h1>Jo Ken Po ‚Äî Sly Ass</h1>
        <div class="subtitle">Pick Rock, Paper or Scissors..I hope you smile SlyAss:)</div>
      </div>

      <div class="controls">
        <div class="badge"><div class="stat" id="playerChoiceDisplay">Choice: ‚Äî</div></div>
        <button class="btn-ghost" id="restartBtn"><span class="dog">üê∂</span> Restart</button>
        <button class="btn-ghost" id="startBtn"><span class="dog">üêï</span> Start</button>
      </div>
    </header>

    <main class="arena-wrap">
      <section class="arena" aria-label="Battle arena">
        <div style="display:flex;gap:8px;align-items:center;justify-content:center;width:100%">
          <div class="piece-btns">
            <button class="piece-btn" data-piece="rock">ü™® Rock</button>
            <button class="piece-btn" data-piece="paper">üìÑ Paper</button>
            <button class="piece-btn" data-piece="scissors">‚úÇÔ∏è Scissors</button>
          </div>
        </div>

        <div class="arena-inner" id="arenaInner">
          <div class="confetti" id="confetti"></div>
          <!-- dynamic rocket elements will be appended here -->
        </div>
      </section>

      <aside class="hud">
        <div class="fancy-hud" id="fancyHud">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Battle Progress</strong>
            <div id="timer">00:00</div>
          </div>
          <div class="counts" style="margin-top:10px">
            <div><div class="stat">ü™® Rock: <span id="countRock">0</span></div></div>
            <div><div class="stat">üìÑ Paper: <span id="countPaper">0</span></div></div>
            <div><div class="stat">‚úÇÔ∏è Scissors: <span id="countScissors">0</span></div></div>
          </div>

          <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
            <div class="stat">Your score: <strong id="playerScore">0</strong></div>
            <div class="stat">Pieces left: <strong id="piecesLeft">0</strong></div>
          </div>
        </div>

        <div class="card" id="hudModal" style="display:block">
          <div id="endMessageInner" style="text-align:center"></div>
        </div>
      </aside>
    </main>

    <footer>Designed by a Sly Ass for a special Sly Ass.</footer>
  </div>

  <!-- ASSETS (comment): put media at assets/video/01.mp4 and assets/audio/01.mp3 -->

  <script>
    /* ================== PARAMETERS - tweak here ================== */
    const TOTAL_PER_TYPE = 14;
    const AGENT_SIZE = 40;
    const CONVERT_COOLDOWN = 360;
    const NUDGE_TIMEOUT = 14000;

    // CRAZY pulses & berserk
    const CRAZY_MOVE_PROB_PER_SECOND = 0.36;
    const CRAZY_MOVE_FORCE = 5.2;
    const CRAZY_MOVE_COUNT = 10;
    const CRAZY_MEGA_PROB = 0.08;
    const CRAZY_MEGA_MULT = 2.6;

    // spawn near-end
    const SPAWN_NEAR_END_THRESHOLD = 8;
    const SPAWN_NEAR_END_PROB = 0.14;
    const SPAWN_NEAR_END_COOLDOWN = 2600;

    // spontaneous random spawns (always-on background randomness)
    const SPONTANEOUS_SPAWN_PROB_PER_SECOND = 0.06; // 6% per second
    const SPONTANEOUS_MAX_PER_MINUTE = 8;

    // monotony detector - triggers more aggressive reaction when game is dull
    const MONOTONY_TIME_MS = 7000;              // how long without conversions before considered monotone
    const MONOTONY_SPEED_THRESHOLD = 0.35;     // avg speed below this considered slow
    const MONOTONY_SPAWN_BOOST = 0.7;          // added probability when monotone
    const MONOTONY_BERSERK_PROB = 0.28;        // chance to trigger berserk when monotone
    const MONOTONY_MAX_STACK = 4;              // repeated monotony increases reaction

    // rocket spawn visuals
    const ROCKET_DURATION = 680;   // ms rocket fly time
    const ROCKET_EMOJI = 'üöÄ';

    const EMOJI = {rock:'ü™®',paper:'üìÑ',scissors:'‚úÇÔ∏è'};
    const BEATS = {rock:'scissors',scissors:'paper',paper:'rock'};

    /* ================== DOM & STATE ================== */
    const arenaInner = document.getElementById('arenaInner');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const pieceBtns = document.querySelectorAll('.piece-btn');
    const playerChoiceDisplay = document.getElementById('playerChoiceDisplay');
    const countRockEl = document.getElementById('countRock');
    const countPaperEl = document.getElementById('countPaper');
    const countScissorsEl = document.getElementById('countScissors');
    const playerScoreEl = document.getElementById('playerScore');
    const piecesLeftEl = document.getElementById('piecesLeft');
    const timerEl = document.getElementById('timer');
    const confetti = document.getElementById('confetti');
    const endMessageInner = document.getElementById('endMessageInner');
    const appContainer = document.getElementById('appContainer');
    const fancyHud = document.getElementById('fancyHud');

    let playerChoice = null;
    let agents = [];
    let running = false;
    let lastTime = null;
    let startTime = null;
    let rafId = null;
    let playerScore = 0;
    let lastConversionAt = 0;

    // monotony tracking
    let monotonyStack = 0;
    let lastMonotonyCheck = 0;
    let lastAutoSpawnAt = 0;
    let crazyAccumulator = 0;
    let spontaneousSpawnCounter = 0;

    // music
    const music = new Audio('assets/audio/01.mp3'); music.loop = true; music.preload = 'auto'; music.volume = 0.66;
    function tryPlayMusic(){ try{ music.currentTime = 0; const p = music.play(); if(p && p.then) p.catch(()=>{}); }catch(e){} }

    /* ========== UI ========== */
    function setPlayerChoice(type){ playerChoice = type; playerChoiceDisplay.textContent = 'Choice: ' + (type ? (EMOJI[type] + ' ' + capitalize(type)) : '‚Äî'); pieceBtns.forEach(b=>b.classList.toggle('active', b.dataset.piece===type)); }
    pieceBtns.forEach(b=>{ b.addEventListener('click', ()=>setPlayerChoice(b.dataset.piece)); b.addEventListener('touchstart', ()=>setPlayerChoice(b.dataset.piece)); });
    restartBtn.addEventListener('click', resetGame);
    startBtn.addEventListener('click', ()=>{ if(!playerChoice){ alert('Please pick a piece before starting.'); return; } if(running) return; resetArena(); spawnAgents(); startBattle(); tryPlayMusic(); });

    function resetGame(){ stopBattle(); clearArena(); setPlayerChoice(null); playerScore=0; updateHUD(); endMessageInner.innerHTML=''; confetti.innerHTML=''; monotonyStack=0; lastAutoSpawnAt=0; spontaneousSpawnCounter=0; }
    function resetArena(){ clearArena(); agents=[]; playerScore=0; updateHUD(); lastConversionAt = performance.now(); monotonyStack=0; lastAutoSpawnAt=0; spontaneousSpawnCounter=0; }
    function clearArena(){ cancelAnimationFrame(rafId); arenaInner.querySelectorAll('.agent, .rocket, .spawn-burst').forEach(n=>n.remove()); agents=[]; running=false; lastTime=null; startTime=null; rafId=null; }

    /* ========== spawn & physics ========== */
    function spawnAgents(){
      const rect = arenaInner.getBoundingClientRect(); const centerX = rect.width/2, centerY = rect.height/2;
      function randAroundCenter(range=280){ return { x: centerX + (Math.random()*2-1)*range, y: centerY + (Math.random()*2-1)*range }; }
      function spawn(type,n){
        for(let i=0;i<n;i++){
          const pos = randAroundCenter(280);
          const el = document.createElement('div'); el.className = 'agent '+type; el.dataset.type=type; el.style.left=(pos.x)+'px'; el.style.top=(pos.y)+'px'; el.innerText=EMOJI[type]; arenaInner.appendChild(el);
          const baseSpeed = 1.6 + Math.random()*3.2;
          const angle = Math.random()*Math.PI*2; agents.push({el,x:pos.x,y:pos.y,vx:Math.cos(angle)*baseSpeed,vy:Math.sin(angle)*baseSpeed,r:AGENT_SIZE/2,type,nextConvertAllowed:0});
        }
      }
      spawn('rock', TOTAL_PER_TYPE); spawn('paper', TOTAL_PER_TYPE); spawn('scissors', TOTAL_PER_TYPE);
      updateHUD(); lastConversionAt = performance.now();
    }

    function spawnSingleRandom(){ const types=['rock','paper','scissors']; spawnSingle(types[Math.floor(Math.random()*3)]); }
    function spawnSingle(type){
      const rect = arenaInner.getBoundingClientRect();
      const pos = { x: 40 + Math.random()*(rect.width-80), y: 40 + Math.random()*(rect.height-80) };
      // rocket visual
      rocketSpawnVisual(pos.x,pos.y);
      const el = document.createElement('div'); el.className='agent '+type; el.dataset.type=type; el.style.left=pos.x+'px'; el.style.top=pos.y+'px'; el.innerText=EMOJI[type]; arenaInner.appendChild(el);
      const baseSpeed = 2.2 + Math.random()*3.4;
      const angle = Math.random()*Math.PI*2; agents.push({el,x:pos.x,y:pos.y,vx:Math.cos(angle)*baseSpeed,vy:Math.sin(angle)*baseSpeed,r:AGENT_SIZE/2,type,nextConvertAllowed: performance.now()+300});
      updateHUD();
    }

    /* rocket spawn visual: emoji rocket flies from bottom to target, then burst */
    function rocketSpawnVisual(targetX,targetY){
      const rect = arenaInner.getBoundingClientRect();
      const rocket = document.createElement('div'); rocket.className='rocket'; rocket.style.left=(targetX-10)+'px'; rocket.style.bottom='-40px'; rocket.innerText=ROCKET_EMOJI; arenaInner.appendChild(rocket);
      // animate: move from bottom to targetY
      const startBottom = -40;
      const endBottom = rect.height - targetY - 12; // convert targetY to bottom offset
      rocket.animate([{transform:`translate(-50%, ${-startBottom}px)`, opacity:1},{transform:`translate(-50%, ${-endBottom}px)`, opacity:1}],{duration:ROCKET_DURATION, easing:'cubic-bezier(.2,.9,.2,1)'});
      // after flight -> burst
      setTimeout(()=>{
        // small burst
        const burstCount = 9 + Math.floor(Math.random()*8);
        for(let i=0;i<burstCount;i++){
          const b = document.createElement('div'); b.className='spawn-burst'; b.style.left=(targetX + (Math.random()*40-20))+'px'; b.style.top=(targetY + (Math.random()*40-20))+'px';
          b.style.background = ['#ff6b6b','#ffd166','#8ecae6','#a0e7a0','#c77dff'][Math.floor(Math.random()*5)];
          const size = 6 + Math.random()*12; b.style.width=size+'px'; b.style.height=size+'px'; arenaInner.appendChild(b);
          const dx = (Math.random()*2-1)*80; const dy = (Math.random()*2-1)*80;
          b.animate([{transform:'scale(0.4) translate(0,0)', opacity:1},{transform:`scale(1) translate(${dx}px, ${dy}px)`, opacity:0}],{duration:700 + Math.random()*500, easing:'cubic-bezier(.2,.9,0.2,1)'});
          setTimeout(()=>b.remove(),1200);
        }
        // remove rocket
        rocket.remove();
      }, ROCKET_DURATION+50);
    }

    function startBattle(){ running=true; startTime=performance.now(); lastTime=startTime; rafId = requestAnimationFrame(loop); }
    function stopBattle(){ running=false; cancelAnimationFrame(rafId); }

    function loop(t){
      const dt = Math.min(0.06,(t-lastTime)/1000); lastTime=t;
      timerEl.textContent = new Date(Math.floor((t-startTime)/1000)*1000).toISOString().substr(14,5);
      updateAgents(dt);
      rafId = requestAnimationFrame(loop);
      checkEndCondition();
    }

    function updateAgents(dt){
      const rect = arenaInner.getBoundingClientRect(); const w=rect.width, h=rect.height;
      // crazy accumulator checks each 0.25s
      crazyAccumulator += dt;
      if(crazyAccumulator >= 0.25){ maybeTriggerCrazyMove(crazyAccumulator); crazyAccumulator = 0; }
      // spontaneous spawn chance per second
      if(Math.random() < SPONTANEOUS_SPAWN_PROB_PER_SECOND * dt && spontaneousSpawnCounter < SPONTANEOUS_MAX_PER_MINUTE){
        spawnSingleRandom(); spontaneousSpawnCounter++;
      }

      for(let a of agents){
        a.vx += (Math.sin((a.x + a.y + performance.now()/900) * 0.001) * 0.04);
        a.x += a.vx*dt; a.y += a.vy*dt;
        if(a.x < 8){ a.x = 8; a.vx = Math.abs(a.vx) * 0.94 + 0.04; }
        if(a.x > w - 40){ a.x = w-40; a.vx = -Math.abs(a.vx) * 0.94 - 0.04; }
        if(a.y < 8){ a.y = 8; a.vy = Math.abs(a.vy) * 0.94 + 0.04; }
        if(a.y > h - 40){ a.y = h-40; a.vy = -Math.abs(a.vy) * 0.94 - 0.04; }
        a.vx *= 0.9991; a.vy *= 0.9991;
        a.vx = Math.max(-6.0, Math.min(6.0, a.vx)); a.vy = Math.max(-6.0, Math.min(6.0, a.vy));
      }

      let anyConversion = false;
      for(let i=0;i<agents.length;i++){
        for(let j=i+1;j<agents.length;j++){
          const A = agents[i], B=agents[j];
          const dx = A.x - B.x, dy = A.y - B.y, dist2 = dx*dx + dy*dy, minDist = (AGENT_SIZE - 6);
          if(dist2 < minDist*minDist){
            const dist = Math.sqrt(dist2) || 0.0001, nx = dx/dist, ny = dy/dist, overlap = (minDist - dist)/2;
            A.x += nx*overlap; A.y += ny*overlap; B.x -= nx*overlap; B.y -= ny*overlap;
            const restitution=0.94;
            const relVel = (A.vx - B.vx)*nx + (A.vy - B.vy)*ny;
            const jimp = -(1+restitution)*relVel*0.5; const jx = jimp*nx, jy=jimp*ny;
            A.vx += jx; A.vy += jy; B.vx -= jx; B.vy -= jy;
            const tang = 0.12*(Math.random()-0.5);
            A.vx += -ny*tang; A.vy += nx*tang; B.vx += ny*tang; B.vy += -nx*tang;
            const now = performance.now();
            if(A.type !== B.type){
              if(now > B.nextConvertAllowed && BEATS[A.type] === B.type){
                convertAgent(B, A.type, A); B.nextConvertAllowed = now + CONVERT_COOLDOWN; anyConversion = true; if(A.type === playerChoice) playerScore++; }
              else if(now > A.nextConvertAllowed && BEATS[B.type] === A.type){
                convertAgent(A, B.type, B); A.nextConvertAllowed = now + CONVERT_COOLDOWN; anyConversion = true; if(B.type === playerChoice) playerScore++; }
            }
          }
        }
      }

      if(anyConversion) lastConversionAt = performance.now();

      // monotony detector & reactions
      maybeMonotonyReact();

      // near-end randomness & spawns
      const now = performance.now();
      if(!monotonyTriggeredOnce && agents.length <= SPAWN_NEAR_END_THRESHOLD && agents.length > 1){ /* no-op: handled in maybeSpawnNearEnd */ }
      maybeSpawnNearEnd(now);

      if(now - lastConversionAt > NUDGE_TIMEOUT){
        for(let k=0;k<Math.min(10, agents.length);k++){ const a = agents[Math.floor(Math.random()*agents.length)]; a.vx += (Math.random()*2-1) * 2.2; a.vy += (Math.random()*2-1) * 2.2; }
        lastConversionAt = now;
      }

      for(let a of agents){ a.el.style.left = (a.x - (AGENT_SIZE/2)) + 'px'; a.el.style.top = (a.y - (AGENT_SIZE/2)) + 'px'; }
      updateHUD();
    }

    // convert + flash + kick
    function convertAgent(target,newType,sourceAgent){
      if(target.type === newType) return;
      target.type = newType; target.el.dataset.type = newType; target.el.className = 'agent '+newType+' convert'; target.el.innerText = EMOJI[newType];
      try{ target.el.animate([{boxShadow:'0 0 0px rgba(255,255,255,0)'},{boxShadow:'0 22px 66px rgba(255,255,255,0.98)'},{boxShadow:'0 0 0px rgba(255,255,255,0)'}],{duration:300,easing:'ease-out'}); }catch(e){}
      if(sourceAgent){ target.vx = (sourceAgent.vx*0.6) + (Math.random()*1.4 - 0.7); target.vy = (sourceAgent.vy*0.6) + (Math.random()*1.4 - 0.7); }
      setTimeout(()=>{ if(target && target.el) target.el.classList.remove('convert'); },520);
    }

    function updateHUD(){ const counts={rock:0,paper:0,scissors:0}; for(let a of agents) counts[a.type]++; countRockEl.textContent=counts.rock; countPaperEl.textContent=counts.paper; countScissorsEl.textContent=counts.scissors; playerScoreEl.textContent=playerScore; piecesLeftEl.textContent=agents.length; }

    function checkEndCondition(){ const typesPresent = new Set(agents.map(a=>a.type)); if(typesPresent.size===1 && agents.length>0){ stopBattle(); const winner=[...typesPresent][0]; const playerWon = (playerChoice===winner); showEndMessage(playerWon,winner); } }

    function showEndMessage(playerWon,winnerType){
      let titleHTML=''; if(playerWon) titleHTML=`<div class='victory-title'>Congratulations sly ass ‚Äî you chose well!</div>`; else titleHTML=`<div class='loser-title'>Not this time sly ass ‚Äî try again.</div>`;
      endMessageInner.innerHTML = `${titleHTML}<div style="margin:10px 0;color:rgba(255,230,120,0.98)">Winner: ${EMOJI[winnerType]} ${capitalize(winnerType)}</div><div><button class='btn-ghost' id='playAgain'><span class='dog'>üê∂</span> Restart</button></div>`;
      document.getElementById('playAgain').addEventListener('click', ()=>{ resetGame(); });
      launchConfetti(playerWon ? 180 : 48);
      fancyHud.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:760,easing:'ease-out'});
    }

    // confetti
    function launchConfetti(n){ confetti.innerHTML=''; const colors=['#ff4d4f','#ffb703','#8ecae6','#a0e7a0','#c77dff','#ffd6a5']; for(let i=0;i<n;i++){ const el=document.createElement('div'); el.className='piece'; el.style.left=Math.random()*100+'%'; el.style.top=(-5 - Math.random()*20)+'vh'; el.style.background=colors[Math.floor(Math.random()*colors.length)]; el.style.transform='rotate('+ (Math.random()*360) +'deg)'; el.style.width=(6 + Math.random()*12)+'px'; el.style.height=(10 + Math.random()*18)+'px'; el.style.animationDuration=(1600 + Math.random()*1200)+'ms'; confetti.appendChild(el); } setTimeout(()=>{ confetti.innerHTML=''; },7000); }

    function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

    /* ================= MONOTONY DETECTOR ================= */
    let monotonyTriggeredOnce = false;
    function maybeMonotonyReact(){
      const now = performance.now();
      const timeSinceLastConv = now - lastConversionAt;
      // compute avg speed
      if(agents.length === 0) return;
      let sumSpeed = 0;
      for(let a of agents) sumSpeed += Math.hypot(a.vx, a.vy);
      const avgSpeed = sumSpeed / agents.length;

      // if slow + no conversion for a while => monotony
      if(timeSinceLastConv > MONOTONY_TIME_MS && avgSpeed < MONOTONY_SPEED_THRESHOLD){
        lastMonotonyCheck = now;
        monotonyStack = Math.min(MONOTONY_MAX_STACK, monotonyStack + 1);
        // spawn boost: high chance to spawn 1-2 pieces with rocket visuals
        const spawns = 1 + Math.floor(Math.random() * Math.min(2, monotonyStack));
        for(let s=0;s<spawns;s++){
          spawnSingleRandom();
        }
        // berserk chance when monotone
        if(Math.random() < (MONOTONY_BERSERK_PROB + monotonyStack * 0.06)){
          triggerBerserk(2200 + Math.random()*1800);
        }
        // HUD pulse to warn player
        fancyHud.animate([{filter:'brightness(1)'},{filter:'brightness(1.22)'},{filter:'brightness(1)'}],{duration:420,easing:'ease-out'});
        monotonyTriggeredOnce = true;
      } else {
        // slowly decay monotony stack if game becomes lively
        if(timeSinceLastConv < MONOTONY_TIME_MS / 2 && monotonyStack > 0){
          monotonyStack = Math.max(0, monotonyStack - 1);
        }
      }
    }

    /* ================= spontaneous + near-end spawn ================= */
    function maybeSpawnNearEnd(now){
      if(agents.length <= SPAWN_NEAR_END_THRESHOLD && agents.length > 1){
        if(now - lastAutoSpawnAt > SPAWN_NEAR_END_COOLDOWN){
          const dtSec = Math.min(1.2, (now - lastAutoSpawnAt)/1000);
          const monotonyBoost = ( (now - lastConversionAt) > MONOTONY_TIME_MS ? MONOTONY_SPAWN_BOOST * (monotonyStack || 1) : 0 );
          const p = SPAWN_NEAR_END_PROB * dtSec + monotonyBoost;
          if(Math.random() < p){
            spawnSingleRandom();
            lastAutoSpawnAt = now;
            fancyHud.animate([{transform:'scale(1)'},{transform:'scale(1.06)'},{transform:'scale(1)'}],{duration:360,easing:'ease-out'});
          }
        }
      }
    }

    /* ================= crazy pulses & berserk ================= */
    function maybeTriggerCrazyMove(elapsedSeconds){
      const p = 1 - Math.pow(1 - CRAZY_MOVE_PROB_PER_SECOND, elapsedSeconds);
      // apply chance higher if monotone
      const monotoneFactor = (performance.now() - lastConversionAt > MONOTONY_TIME_MS) ? (1 + (monotonyStack*0.25)) : 1;
      if(Math.random() < p * monotoneFactor && agents.length > 3){
        // normal crazy pulse
        for(let k=0;k<Math.min(CRAZY_MOVE_COUNT, agents.length);k++){
          const a = agents[Math.floor(Math.random()*agents.length)];
          a.vx += (Math.random()*2-1) * CRAZY_MOVE_FORCE;
          a.vy += (Math.random()*2-1) * CRAZY_MOVE_FORCE;
        }
        fancyHud.animate([{filter:'brightness(1)'},{filter:'brightness(1.28)'},{filter:'brightness(1)'}],{duration:440,easing:'ease-out'});

        // maybe mega storm
        if(Math.random() < CRAZY_MEGA_PROB && agents.length > 6){
          for(let k=0;k<Math.min(agents.length, CRAZY_MOVE_COUNT * 2);k++){
            const a = agents[Math.floor(Math.random()*agents.length)];
            a.vx += (Math.random()*2-1) * CRAZY_MOVE_FORCE * CRAZY_MEGA_MULT;
            a.vy += (Math.random()*2-1) * CRAZY_MOVE_FORCE * CRAZY_MEGA_MULT;
          }
          appContainer.classList.add('shake'); setTimeout(()=>appContainer.classList.remove('shake'),800);
          fancyHud.animate([{transform:'translateY(0)'},{transform:'translateY(-10px)'},{transform:'translateY(0)'}],{duration:740,easing:'ease-out'});
        }
      }
    }

    function triggerBerserk(durationMs=3000){
      // temporarily apply stronger random impulses repeatedly
      const end = performance.now() + durationMs;
      const interval = setInterval(()=>{
        for(let i=0;i<Math.min(12,agents.length);i++){
          const a = agents[Math.floor(Math.random()*agents.length)]; a.vx += (Math.random()*2-1) * CRAZY_MOVE_FORCE * 1.2; a.vy += (Math.random()*2-1) * CRAZY_MOVE_FORCE * 1.2;
        }
        fancyHud.animate([{filter:'brightness(1)'},{filter:'brightness(1.4)'},{filter:'brightness(1)'}],{duration:320,easing:'ease-out'});
        appContainer.classList.add('shake'); setTimeout(()=>appContainer.classList.remove('shake'),260);
        if(performance.now() > end) clearInterval(interval);
      }, 420 + Math.random()*320);
    }

    /* =================== init / helpers =================== */
    setPlayerChoice(null);
    window.addEventListener('resize', ()=>{ const rect = arenaInner.getBoundingClientRect(); for(let a of agents){ a.x = Math.max(8, Math.min(rect.width-32, a.x)); a.y = Math.max(8, Math.min(rect.height-32, a.y)); }});
    window.addEventListener('load', ()=>{ tryPlayMusic(); });

    // small utility: occasional forced spawn if the player wants to test monotony response
    window.forceSpawn = spawnSingleRandom;
  </script>
</body>
</html>
